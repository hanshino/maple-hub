# Feature Specification: 戰力排行榜頁面

**Feature Branch**: `014-combat-power-leaderboard`  
**Created**: 2025-12-06  
**Status**: Draft  
**Input**: User description: "現在我在 google sheet 上面有紀錄每個角色的戰力，我想要新增一個排行榜頁面，可以看目前我有紀錄的角色裡面的戰力榜，當然要記得做分頁，顯示角色 icon 角色名稱 角色等級 角色伺服器 角色戰力 的資訊"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 瀏覽戰力排行榜 (Priority: P1)

身為使用者，我希望能夠查看所有已記錄角色的戰力排行榜，讓我可以快速了解目前記錄中戰力最強的角色排名。

**Why this priority**: 這是排行榜功能的核心價值，讓使用者可以一目了然地看到戰力排名，是整個功能的基礎。

**Independent Test**: 可以透過訪問排行榜頁面並確認顯示角色資訊列表來驗證，即使沒有分頁功能，也能提供完整的排行榜價值。

**Acceptance Scenarios**:

1. **Given** 使用者進入排行榜頁面, **When** 頁面載入完成, **Then** 顯示依戰力由高到低排序的角色列表，每個角色顯示排名、角色 icon、角色名稱、角色等級、角色伺服器、角色戰力
2. **Given** 排行榜頁面已載入, **When** 使用者查看列表, **Then** 可以清楚辨識每個角色的排名順位（1、2、3...）
3. **Given** Google Sheet 上有 50 筆角色戰力記錄, **When** 使用者進入排行榜, **Then** 顯示前 20 筆角色列表（初始載入筆數）

---

### User Story 2 - 無限滾動載入更多資料 (Priority: P2)

身為使用者，我希望能透過向下滾動頁面來自動載入更多角色資料，讓我可以流暢地瀏覽整個排行榜，無需手動點擊翻頁按鈕。

**Why this priority**: 無限滾動提供更流暢的瀏覽體驗，當記錄的角色數量增加時，確保頁面效能與使用者體驗，但在初期角色較少時，即使沒有此功能也能使用。

**Independent Test**: 可以透過模擬多筆角色資料並測試滾動到底部時自動載入更多資料來驗證。

**Acceptance Scenarios**:

1. **Given** 排行榜共有 50 筆資料且初始載入 20 筆, **When** 使用者滾動到列表底部, **Then** 自動載入下一批 20 筆資料（第 21-40 名）並附加到列表下方
2. **Given** 使用者已滾動載入第 21-40 名資料, **When** 使用者繼續滾動到底部, **Then** 自動載入剩餘的第 41-50 名資料
3. **Given** 所有資料已載入完畢, **When** 使用者滾動到底部, **Then** 顯示「已載入全部資料」提示，不再發送載入請求
4. **Given** 使用者正在滾動載入中, **When** 資料載入中, **Then** 顯示載入指示器（如 spinner）
5. **Given** 排行榜共有 50 筆資料, **When** 使用者查看頁面, **Then** 顯示目前已載入筆數與總筆數資訊（如「已載入 20 / 50 筆」）

---

### User Story 3 - 從導覽列進入排行榜 (Priority: P3)

身為使用者，我希望能從網站導覽列快速進入排行榜頁面，讓我可以方便地存取此功能。

**Why this priority**: 導覽整合提升使用者體驗，但排行榜本身可以透過直接輸入網址存取，不影響核心功能。

**Independent Test**: 可以透過確認導覽列顯示排行榜連結並能正確導向來驗證。

**Acceptance Scenarios**:

1. **Given** 使用者在任何頁面, **When** 使用者查看導覽列, **Then** 顯示「排行榜」連結選項
2. **Given** 使用者點擊導覽列的「排行榜」, **When** 頁面轉跳, **Then** 進入排行榜頁面

---

### Edge Cases

- 當 Google Sheet 上沒有任何角色戰力記錄時，顯示友善的空狀態訊息（如「目前沒有記錄的角色資料」）
- 當 Google Sheet API 連線失敗時，顯示錯誤訊息並提供重試選項
- 當角色缺少部分資訊（如沒有角色 icon）時，顯示預設圖示替代
- 當有多個角色戰力相同時，維持穩定的排序（可依角色名稱作為次要排序依據）
- 當使用者快速滾動時，應避免重複發送載入請求（防抖處理）
- 當載入下一批資料時發生網路錯誤，顯示錯誤訊息並提供「點擊重試」選項
- 當角色資訊快取尚未建立時，仍顯示排名和戰力，角色詳情欄位顯示為「載入中」或空白

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系統 MUST 提供一個可存取的排行榜頁面路徑
- **FR-002**: 系統 MUST 從 Google Sheet 的 CombatPower 工作表讀取角色戰力資料
- **FR-003**: 系統 MUST 從 CharacterInfo 快取工作表讀取角色基本資訊（icon、名稱、等級、伺服器）
- **FR-004**: 系統 MUST 將角色依戰力由高到低排序顯示
- **FR-005**: 系統 MUST 為每個角色顯示其排名順位（1、2、3...）
- **FR-006**: 系統 MUST 提供無限滾動功能，初始載入 20 筆資料，滾動到底部時自動載入下一批
- **FR-007**: 系統 MUST 在資料載入中顯示載入指示器
- **FR-008**: 系統 MUST 顯示已載入筆數與總筆數資訊
- **FR-009**: 系統 MUST 在導覽列新增「排行榜」連結
- **FR-010**: 系統 MUST 在無資料時顯示友善的空狀態訊息
- **FR-011**: 系統 MUST 在 API 錯誤時顯示錯誤訊息
- **FR-012**: 系統 MUST 在角色缺少 icon 時顯示預設圖示
- **FR-013**: 系統 MUST 在所有資料載入完畢時顯示提示訊息
- **FR-014**: 系統 MUST 在載入失敗時提供重試機制
- **FR-015**: 系統 MUST 提供 CRON API 端點供外部服務定期更新角色資訊快取
- **FR-016**: 系統 MUST 使用 CharacterInfo 工作表作為角色資訊快取層，避免多用戶重複呼叫 Nexon API

### Key Entities

- **角色排行資訊**: 整合戰力數據與角色基本資訊的複合資料，包含排名、OCID、角色 icon、角色名稱、角色等級、角色伺服器、角色戰力、最後更新時間
- **滾動載入狀態**: 記錄目前已載入筆數、每批載入筆數、總筆數、是否載入中、是否全部載入完畢
- **角色資訊快取**: Google Sheet CharacterInfo 工作表，儲存角色基本資訊，由背景 CRON 任務定期更新
- **CombatPower 工作表**: Google Sheet 中儲存 OCID 與戰力對應資料的工作表（現有）

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 使用者可以在 3 秒內看到排行榜首頁內容（首次載入時間）
- **SC-002**: 滾動載入下一批資料在 1 秒內完成並顯示
- **SC-003**: 排行榜頁面正確顯示所有 5 項角色資訊（icon、名稱、等級、伺服器、戰力）
- **SC-004**: 排行榜排序正確率 100%（戰力由高到低，相同戰力時排序穩定）
- **SC-005**: 無限滾動功能正常運作，可瀏覽所有已記錄的角色資料
- **SC-006**: 多用戶同時訪問排行榜不會觸發重複的 Nexon API 呼叫

## Assumptions

- Google Sheet 上的 CombatPower 工作表已存在，且包含 ocid、combat_power、updated_at、status 欄位（根據現有專案結構）
- 可以透過 OCID 呼叫現有的 Nexon API 取得角色基本資訊（icon、名稱、等級、伺服器）
- 使用現有的 Material-UI 元件庫來建構排行榜頁面 UI
- 無限滾動每批載入 20 筆，此數值可在實作時依效能調整
- 戰力相同時，以 OCID 作為次要排序依據（確保穩定排序）
- 角色資訊快取（CharacterInfo 工作表）每 6 小時由外部 CRON 服務觸發更新
- 快取過期但尚未更新時，仍使用舊快取資料（避免阻塞使用者）

## Clarifications

### Session 2025-12-06

- Q: 分頁瀏覽方式應採用傳統翻頁按鈕還是無限滾動？ → A: 無限滾動（Infinite Scroll），滾動到底部自動載入下一批資料
- Q: 多用戶訪問時如何避免重複呼叫 Nexon API？ → A: 使用 Google Sheet CharacterInfo 工作表作為共享快取層，由背景 CRON 任務定期更新，排行榜 API 直接讀取快取
