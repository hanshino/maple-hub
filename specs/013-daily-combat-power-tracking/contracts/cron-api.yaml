openapi: 3.0.3
info:
  title: Combat Power Refresh Cron API
  description: |
    每日戰鬥力數據收集的 Cron API 端點。
    設計用於被外部 cron 服務（如 cron-job.org）調用。
  version: 1.0.0

servers:
  - url: /api/cron
    description: Cron API endpoints

paths:
  /combat-power-refresh:
    get:
      summary: Refresh combat power data for a batch of OCIDs
      description: |
        從 Google Sheet 讀取指定批次的 OCID，透過 Nexon API 獲取戰鬥力數據，
        並將結果覆蓋更新回 Google Sheet。

        設計為支援分批處理，每次調用處理一個批次，
        透過 hasMore 和 nextOffset 支援鏈式調用或多任務配置。
      operationId: refreshCombatPower
      security:
        - BearerAuth: []
      parameters:
        - name: offset
          in: query
          description: 起始位置（從第幾個 OCID 開始處理）
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: batchSize
          in: query
          description: 每批處理的 OCID 數量
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 20
            default: 15
      responses:
        '200':
          description: 批次處理成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshResponse'
              examples:
                success_with_more:
                  summary: 成功處理，還有更多待處理
                  value:
                    success: true
                    processed: 15
                    offset: 0
                    batchSize: 15
                    nextOffset: 15
                    totalCount: 100
                    hasMore: true
                    stats:
                      success: 14
                      failed: 0
                      notFound: 1
                    executionTimeMs: 4523
                    timestamp: '2025-12-06T02:00:00.000Z'
                success_complete:
                  summary: 處理完成，無更多待處理
                  value:
                    success: true
                    processed: 10
                    offset: 90
                    batchSize: 15
                    nextOffset: 100
                    totalCount: 100
                    hasMore: false
                    stats:
                      success: 10
                      failed: 0
                      notFound: 0
                    executionTimeMs: 3012
                    timestamp: '2025-12-06T02:00:30.000Z'
                empty:
                  summary: 無 OCID 待處理
                  value:
                    success: true
                    processed: 0
                    offset: 0
                    batchSize: 15
                    nextOffset: 0
                    totalCount: 0
                    hasMore: false
                    stats:
                      success: 0
                      failed: 0
                      notFound: 0
                    executionTimeMs: 150
                    timestamp: '2025-12-06T02:00:00.000Z'
        '401':
          description: 未授權 - CRON_SECRET 驗證失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Unauthorized
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Failed to read OCIDs from Google Sheets'
                timestamp: '2025-12-06T02:00:00.000Z'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: |
        使用環境變數 CRON_SECRET 的值作為 Bearer Token。
        Header 格式: `Authorization: Bearer <CRON_SECRET>`

  schemas:
    RefreshResponse:
      type: object
      required:
        - success
        - processed
        - offset
        - batchSize
        - nextOffset
        - totalCount
        - hasMore
        - stats
        - timestamp
      properties:
        success:
          type: boolean
          description: 批次處理是否成功完成
        processed:
          type: integer
          description: 本批次實際處理的 OCID 數量
        offset:
          type: integer
          description: 本批次的起始位置
        batchSize:
          type: integer
          description: 請求的批次大小
        nextOffset:
          type: integer
          description: 下一批次的起始位置（用於鏈式調用）
        totalCount:
          type: integer
          description: OCID 總數
        hasMore:
          type: boolean
          description: 是否還有更多 OCID 待處理
        stats:
          $ref: '#/components/schemas/ProcessingStats'
        executionTimeMs:
          type: integer
          description: 執行時間（毫秒）
        timestamp:
          type: string
          format: date-time
          description: 響應時間戳

    ProcessingStats:
      type: object
      required:
        - success
        - failed
        - notFound
      properties:
        success:
          type: integer
          description: 成功獲取戰鬥力的 OCID 數量
        failed:
          type: integer
          description: API 錯誤的 OCID 數量
        notFound:
          type: integer
          description: 角色不存在的 OCID 數量

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        success:
          type: boolean
          default: false
        error:
          type: string
          description: 錯誤訊息
        timestamp:
          type: string
          format: date-time
          description: 錯誤發生時間
